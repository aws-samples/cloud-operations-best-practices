<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-recipes/centralized-operations-management/pwsh-run-command-custom-credentials/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Invoking PowerShell commands as a custom Windows user in Systems Manager Run Command | AWS Cloud Operations Best Practices</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://aws-samples.github.io/cloud-operations-best-practices/docs/recipes/centralized-operations-management/pwsh-run-command-custom-credentials/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Invoking PowerShell commands as a custom Windows user in Systems Manager Run Command | AWS Cloud Operations Best Practices"><meta data-rh="true" name="description" content="By default, Systems Manager Run Command uses the local SYSTEM account to run commands on Windows managed nodes. However, in certain scenarios, operations engineers require custom user permissions when running commands. For example, to run Active Directory Domain tasks or to scope down the privileges for the command session."><meta data-rh="true" property="og:description" content="By default, Systems Manager Run Command uses the local SYSTEM account to run commands on Windows managed nodes. However, in certain scenarios, operations engineers require custom user permissions when running commands. For example, to run Active Directory Domain tasks or to scope down the privileges for the command session."><link data-rh="true" rel="icon" href="/cloud-operations-best-practices/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws-samples.github.io/cloud-operations-best-practices/docs/recipes/centralized-operations-management/pwsh-run-command-custom-credentials/"><link data-rh="true" rel="alternate" href="https://aws-samples.github.io/cloud-operations-best-practices/docs/recipes/centralized-operations-management/pwsh-run-command-custom-credentials/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws-samples.github.io/cloud-operations-best-practices/docs/recipes/centralized-operations-management/pwsh-run-command-custom-credentials/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Recipes","item":"https://aws-samples.github.io/cloud-operations-best-practices/docs/recipes/"},{"@type":"ListItem","position":2,"name":"Centralized Operations Management","item":"https://aws-samples.github.io/cloud-operations-best-practices/docs/recipes/centralized-operations-management/"},{"@type":"ListItem","position":3,"name":"Invoking PowerShell commands as a custom Windows user in Systems Manager Run Command","item":"https://aws-samples.github.io/cloud-operations-best-practices/docs/recipes/centralized-operations-management/pwsh-run-command-custom-credentials/"}]}</script><link rel="stylesheet" href="/cloud-operations-best-practices/assets/css/styles.5bee5787.css">
<script src="/cloud-operations-best-practices/assets/js/runtime~main.583b7e89.js" defer="defer"></script>
<script src="/cloud-operations-best-practices/assets/js/main.696ab665.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cloud-operations-best-practices/"><b class="navbar__title text--truncate">AWS Cloud Operations Best Practices</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/home">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/guides/">Guides</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/tools/">Solutions</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/recipes/">Recipes</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/faq/">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/contributors">Contributors</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/resources/">Resources</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/cloud-operations-best-practices/docs/recipes/centralized-operations-management/pwsh-run-command-custom-credentials/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><a href="https://github.com/aws-samples/cloud-operations-best-practices" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-operations-best-practices/docs/home">What is AWS Cloud Operations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/cloud-operations-best-practices/docs/guides/">Best practices</a><button aria-label="Expand sidebar category &#x27;Best practices&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/cloud-operations-best-practices/docs/tools/">Solutions</a><button aria-label="Expand sidebar category &#x27;Solutions&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/cloud-operations-best-practices/docs/recipes/">Recipes</a><button aria-label="Collapse sidebar category &#x27;Recipes&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cloud-operations-best-practices/docs/recipes/AWS CloudTrail/">AWS CloudTrail</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cloud-operations-best-practices/docs/recipes/application-operations/">Application Operations</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/cloud-operations-best-practices/docs/recipes/centralized-operations-management/">Centralized Operations Management</a><button aria-label="Collapse sidebar category &#x27;Centralized Operations Management&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/cloud-operations-best-practices/docs/recipes/centralized-operations-management/just-in-time-node-access/">Just-in-time node access (JITNA)</a><button aria-label="Expand sidebar category &#x27;Just-in-time node access (JITNA)&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cloud-operations-best-practices/docs/recipes/centralized-operations-management/pwsh-run-command-custom-credentials/">Invoking PowerShell commands as a custom Windows user in Systems Manager Run Command</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/cloud-operations-best-practices/docs/faq/">FAQ</a><button aria-label="Expand sidebar category &#x27;FAQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-operations-best-practices/docs/resources/">Resources</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-operations-best-practices/docs/contributors">Contributors</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/cloud-operations-best-practices/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cloud-operations-best-practices/docs/recipes/"><span>Recipes</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cloud-operations-best-practices/docs/recipes/centralized-operations-management/"><span>Centralized Operations Management</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Invoking PowerShell commands as a custom Windows user in Systems Manager Run Command</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Invoking PowerShell commands as a custom Windows user in Systems Manager Run Command</h1></header>
<p>By default, <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/run-command.html" target="_blank" rel="noopener noreferrer">Systems Manager Run Command</a> uses the local <code>SYSTEM</code> account to run commands on Windows managed nodes. However, in certain scenarios, operations engineers require custom user permissions when running commands. For example, to run Active Directory Domain tasks or to scope down the privileges for the command session.</p>
<p>When handling user credentials in PowerShell, we recommend storing them in <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html" target="_blank" rel="noopener noreferrer">AWS Secrets Manager</a> and retrieving them programmatically from the script. This avoids exposing the credentials in plain text at any point of the execution.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The managed node must have permissions to access the secret in Secrets Manager. Permissions can be granted to the EC2 IAM instance profile attached, the IAM service role specified in your <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/fleet-manager-default-host-management-configuration.html" target="_blank" rel="noopener noreferrer">Default Host Management Configuration</a> (DHMC) service setting, or the IAM service role for the <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-hybrid-multicloud.html" target="_blank" rel="noopener noreferrer">hybrid managed node</a>. For more information, see <a href="https://docs.aws.amazon.com/mediaconnect/latest/ug/iam-policy-examples-asm-secrets.html" target="_blank" rel="noopener noreferrer">IAM policy examples for secrets in AWS Secrets Manager</a>.</p></div></div>
<p>The below example shows a script to retrieve Domain credentials from Secrets Manager and run a PowerShell script with those credentials:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm" style="counter-reset:line-count 0"><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic"># Retrieves AWS Secrets Manager secret</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$SecretContent</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Get-SECSecretValue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">SecretId &lt;SECRET_ARN&gt; </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ErrorAction Stop </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Select-Object</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ExpandProperty </span><span class="token string" style="color:#e3116c">&#x27;SecretString&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ConvertFrom-Json</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ErrorAction Stop</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Creates credentials object</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$Username</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$SecretContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">username</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$UserPassword</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">ConvertTo-SecureString</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$SecretContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">AsPlainText </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Force</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$Credentials</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">New-Object</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">TypeName </span><span class="token string" style="color:#e3116c">&#x27;System.Management.Automation.PSCredential&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$Username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$UserPassword</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Run commands with Domain Credentials</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token function" style="color:#d73a49">Invoke-Command</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Authentication </span><span class="token string" style="color:#e3116c">&#x27;CredSSP&#x27;</span><span class="token plain"> `</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ComputerName </span><span class="token variable" style="color:#36acaa">$env</span><span class="token plain">:COMPUTERNAME `</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Credential </span><span class="token variable" style="color:#36acaa">$Credentials</span><span class="token plain"> `</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ScriptBlock </span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Logged in as:&quot;</span><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">whoami</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span></span><br></span></code></pre></div></div>
<p>The output in Run Command shows the successful log in as the desired domain user:</p>
<p><img decoding="async" loading="lazy" alt="Run Command output with CredSSP" src="/cloud-operations-best-practices/assets/images/example-1-command-output-c54ec8709583b5f03c2b863bac9cfa60.png" width="1710" height="1083" class="img_ev3q"></p>
<p>Another alternative is using PowerShell Session (<code>PSSession</code>). The following code also uses Secrets Manager to retrieve Local Administrator credentials and run a command under this context:</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm" style="counter-reset:line-count 0"><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic"># Retrieves AWS Secrets Manager secret</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$SecretContent</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">Get-SECSecretValue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">SecretId &lt;SECRET_ARN&gt; </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ErrorAction Stop </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Select-Object</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ExpandProperty </span><span class="token string" style="color:#e3116c">&#x27;SecretString&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ConvertFrom-Json</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ErrorAction Stop</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Creates credentials object</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$Username</span><span class="token plain"> = </span><span class="token variable" style="color:#36acaa">$SecretContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">username</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$UserPassword</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">ConvertTo-SecureString</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">$SecretContent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">password</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">AsPlainText </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Force</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$Credentials</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">New-Object</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">TypeName </span><span class="token string" style="color:#e3116c">&#x27;System.Management.Automation.PSCredential&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$Env</span><span class="token string" style="color:#e3116c">:ComputerName\</span><span class="token string variable" style="color:#36acaa">$Username</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$UserPassword</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Creates a new PowerShell session on the local computer using provided credentials</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token variable" style="color:#36acaa">$Session</span><span class="token plain"> = </span><span class="token function" style="color:#d73a49">New-PSSession</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ComputerName </span><span class="token variable" style="color:#36acaa">$Env</span><span class="token plain">:ComputerName </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Credential </span><span class="token variable" style="color:#36acaa">$Credentials</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ErrorAction Stop</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Runs a command in the remote session to start a process and wait for completion</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token function" style="color:#d73a49">Invoke-Command</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Session </span><span class="token variable" style="color:#36acaa">$Session</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ScriptBlock </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Write-Host</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Logged in as: </span><span class="token string variable" style="color:#36acaa">$env</span><span class="token string" style="color:#e3116c">:USERNAME&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span></span><br></span></code></pre></div></div>
<p>The below image shows the Run Command output after running this PowerShell script:</p>
<p><img decoding="async" loading="lazy" alt="Run Command output with PSSession" src="/cloud-operations-best-practices/assets/images/example-2-command-output-0c280a649cad29b47b682ccf925ce141.png" width="3470" height="1910" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The Secrets Manager secret used on these examples stores credentials in the following key/value pair format:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;username&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;XXXXXXXXX&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;password&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;XXXXXXX&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<p>Find more details on creating a Secrets Manager secret <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/create_secret.html" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-a-custom-run-command-document-to-automatically-assume-custom-credentials-and-run-a-powershell-script">Use a custom Run Command document to automatically assume custom credentials and run a PowerShell script<a href="#use-a-custom-run-command-document-to-automatically-assume-custom-credentials-and-run-a-powershell-script" class="hash-link" aria-label="Direct link to Use a custom Run Command document to automatically assume custom credentials and run a PowerShell script" title="Direct link to Use a custom Run Command document to automatically assume custom credentials and run a PowerShell script">​</a></h2>
<p>To automate the secret retrieval and credentials manipulations, you can <a href="https://aws.amazon.com/blogs/mt/writing-your-own-aws-systems-manager-documents/" target="_blank" rel="noopener noreferrer">create</a> a custom Run Command document with the below content:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">schemaVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2.2&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Command document example to retrieve a secret from AWS Secrets Manager and run a PowerShell command using the credentials&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">parameters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">SecretId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> The ARN or name of the secret to retrieve. To retrieve a secret from another account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> you must use an ARN.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret ARN or Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Run a PowerShell script.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Write</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Host &quot;Logged in as</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">&quot;$(whoami)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">displayType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> textarea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">mainSteps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">action</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">runPowerShellScript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ExecutePowerShellCommand</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">inputs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">runCommand</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">           # Retrieves AWS Secrets Manager secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            $SecretContent = Get-SECSecretValue -SecretId {{SecretId}} -ErrorAction Stop | Select-Object -ExpandProperty &#x27;SecretString&#x27; | ConvertFrom-Json -ErrorAction Stop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Creates credentials object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $Username = $SecretContent.username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $UserPassword = ConvertTo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SecureString ($SecretContent.password) </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">AsPlainText </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $Credentials = New</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Object </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">TypeName &#x27;System.Management.Automation.PSCredential&#x27; (&quot;$Env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ComputerName\$Username&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> $UserPassword)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Creates a new PowerShell session on the local computer using provided credentials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $Session = New</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">PSSession </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ComputerName $Env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">ComputerName </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Credential $Credentials </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ErrorAction Stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Runs a command in the remote session to start a process and wait for completion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Invoke</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Command </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Session $Session </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ScriptBlock </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Command</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ErrorAction Stop</span><br></span></code></pre></div></div>
<p>As a result, you will have a template document which only requires Secret ARN and script content for each invocation:</p>
<p><img decoding="async" loading="lazy" alt="Custom Run Command Doc settings" src="/cloud-operations-best-practices/assets/images/custom-command-doc-settings-a009debf44714d8193c034e228bb722e.png" width="1527" height="1202" class="img_ev3q"></p>
<p>A successful command invocation will show the following results:</p>
<p><img decoding="async" loading="lazy" alt="Custom Run Command Doc output" src="/cloud-operations-best-practices/assets/images/custom-command-doc-output-8809102549e0ae3c66a90ac323d1e5ea.png" width="1594" height="1001" class="img_ev3q"></p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/cloud-operations-best-practices/docs/recipes/centralized-operations-management/just-in-time-node-access/policy-examples"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">JITNA Cedar policy examples</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cloud-operations-best-practices/docs/faq/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">FAQ</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#use-a-custom-run-command-document-to-automatically-assume-custom-credentials-and-run-a-powershell-script" class="table-of-contents__link toc-highlight">Use a custom Run Command document to automatically assume custom credentials and run a PowerShell script</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> © 2025.  Amazon.com, Inc. or its affiliates. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>