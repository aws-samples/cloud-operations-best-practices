<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-solutions/AWS CloudTrail/automating-cloudtrail-log-management" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Automating CloudTrail Log Management using Amazon Athena | AWS Cloud Operations Best Practices</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://aws-samples.github.io/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/automating-cloudtrail-log-management"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Automating CloudTrail Log Management using Amazon Athena | AWS Cloud Operations Best Practices"><meta data-rh="true" name="description" content="A guide to automating AWS CloudTrail log analysis using partitioned Athena tables for optimized performance, cost reduction, and enhanced security investigations."><meta data-rh="true" property="og:description" content="A guide to automating AWS CloudTrail log analysis using partitioned Athena tables for optimized performance, cost reduction, and enhanced security investigations."><link data-rh="true" rel="icon" href="/cloud-operations-best-practices/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aws-samples.github.io/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/automating-cloudtrail-log-management"><link data-rh="true" rel="alternate" href="https://aws-samples.github.io/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/automating-cloudtrail-log-management" hreflang="en"><link data-rh="true" rel="alternate" href="https://aws-samples.github.io/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/automating-cloudtrail-log-management" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Solutions","item":"https://aws-samples.github.io/cloud-operations-best-practices/docs/solutions/"},{"@type":"ListItem","position":2,"name":"AWS CloudTrail","item":"https://aws-samples.github.io/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/"},{"@type":"ListItem","position":3,"name":"Automating CloudTrail Log Management using Amazon Athena","item":"https://aws-samples.github.io/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/automating-cloudtrail-log-management"}]}</script><link rel="stylesheet" href="/cloud-operations-best-practices/assets/css/styles.4d5a722e.css">
<script src="/cloud-operations-best-practices/assets/js/runtime~main.090c0998.js" defer="defer"></script>
<script src="/cloud-operations-best-practices/assets/js/main.9f60db74.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cloud-operations-best-practices/"><b class="navbar__title text--truncate">AWS Cloud Operations Best Practices</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/home">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/guides/">Guides</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/solutions/">Solutions</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/recipes/">Recipes</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/faq/">FAQ</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/contributors">Contributors</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cloud-operations-best-practices/docs/resources/">Resources</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/automating-cloudtrail-log-management" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><a href="https://github.com/aws-samples/cloud-operations-best-practices" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-operations-best-practices/docs/home"><span title="What is AWS Cloud Operations" class="linkLabel_WmDU">What is AWS Cloud Operations</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cloud-operations-best-practices/docs/guides/"><span title="Best practices" class="categoryLinkLabel_W154">Best practices</span></a><button aria-label="Expand sidebar category &#x27;Best practices&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/cloud-operations-best-practices/docs/solutions/"><span title="Solutions" class="categoryLinkLabel_W154">Solutions</span></a><button aria-label="Collapse sidebar category &#x27;Solutions&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/"><span title="AWS CloudTrail" class="categoryLinkLabel_W154">AWS CloudTrail</span></a><button aria-label="Collapse sidebar category &#x27;AWS CloudTrail&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/automating-cloudtrail-log-management"><span title="Automating CloudTrail Log Management using Amazon Athena" class="linkLabel_WmDU">Automating CloudTrail Log Management using Amazon Athena</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cloud-operations-best-practices/docs/solutions/application-operations/"><span title="Application Operations" class="linkLabel_WmDU">Application Operations</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cloud-operations-best-practices/docs/solutions/centralized-operations-management/"><span title="Centralized Operations Management" class="categoryLinkLabel_W154">Centralized Operations Management</span></a><button aria-label="Expand sidebar category &#x27;Centralized Operations Management&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cloud-operations-best-practices/docs/recipes/"><span title="Recipes" class="categoryLinkLabel_W154">Recipes</span></a><button aria-label="Expand sidebar category &#x27;Recipes&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cloud-operations-best-practices/docs/faq/"><span title="FAQ" class="categoryLinkLabel_W154">FAQ</span></a><button aria-label="Expand sidebar category &#x27;FAQ&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-operations-best-practices/docs/resources/"><span title="Resources" class="linkLabel_WmDU">Resources</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cloud-operations-best-practices/docs/contributors"><span title="Contributors" class="linkLabel_WmDU">Contributors</span></a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/cloud-operations-best-practices/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cloud-operations-best-practices/docs/solutions/"><span>Solutions</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/"><span>AWS CloudTrail</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Automating CloudTrail Log Management using Amazon Athena</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Automating CloudTrail Log Management using Amazon Athena</h1></header>
<hr>
<p>AWS CloudTrail provides comprehensive monitoring and logging of account activity across your AWS infrastructure, capturing API calls and events for auditing, compliance, and security investigations. However, as AWS environments scale, particularly in multi-account organizations, the volume of CloudTrail logs can grow significantly, leading to increased query times and costs when analyzing logs in Amazon Athena. To address this, we recommend automating the creation and management of partitioned Athena tables to optimize query performance and reduce costs. This best practice guide outlines how to implement an automated solution using AWS Lambda and Amazon Athena to partition CloudTrail logs by account, region, and date, enabling efficient log analysis for security, compliance, and operational use cases.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-partitioned-athena-tables-for-cloudtrail-logs">Configure Partitioned Athena Tables for CloudTrail Logs<a href="#configure-partitioned-athena-tables-for-cloudtrail-logs" class="hash-link" aria-label="Direct link to Configure Partitioned Athena Tables for CloudTrail Logs" title="Direct link to Configure Partitioned Athena Tables for CloudTrail Logs" translate="no">​</a></h2>
<p>To optimize query performance and reduce costs, configure partitioned Athena tables for CloudTrail logs using an automated solution. This approach involves deploying two AWS Lambda functions to create and maintain account-specific and organization-wide Athena tables, partitioned by account ID, region, and date. Partitioning ensures that Athena scans only relevant data during queries, significantly improving query speed and reducing costs compared to scanning unpartitioned datasets. For example, when investigating suspicious activity for a specific AWS account within a defined time frame, Athena will scan only the relevant partitions, rather than the entire log dataset.</p>
<ul>
<li class=""><strong><a href="https://github.com/aws-samples/sample-automation-cloudtrail-athena" target="_blank" rel="noopener noreferrer" class="">Deploy this CloudFormation Template for Automation</a></strong>: Use this CloudFormation template to deploy the solution, which includes two Lambda functions, IAM roles, an AWS Glue database, and predefined Athena queries. The template automates the setup of partitioned tables, eliminating manual configuration and ensuring consistency across environments. GitHub solution can be found <a href="https://github.com/aws-samples/sample-automation-cloudtrail-athena" target="_blank" rel="noopener noreferrer" class="">here</a>.</li>
<li class=""><strong><a href="https://docs.aws.amazon.com/athena/latest/ug/create-cloudtrail-table-partition-projection.html" target="_blank" rel="noopener noreferrer" class="">CloudTrail logs in Athena using partition projection</a></strong>: This solution uses Athena projection partitioning which, due to CloudTrail logs having a known structure with predefined partition schemes, allows you to reduce query runtime and automate partition management by using the Athena partition projection feature. Partition projection automatically adds new partitions as new data is added. This removes the need for you to manually add partitions by using <code>ALTER TABLE ADD PARTITION</code>.</li>
<li class=""><strong><a href="https://docs.aws.amazon.com/firehose/latest/dev/dynamic-partitioning-s3bucketprefix.html" target="_blank" rel="noopener noreferrer" class="">Specify CloudTrail S3 Bucket and Prefix</a></strong>: Provide the CloudTrail S3 bucket name and the appropriate prefix as inputs to the CloudFormation template. For organizational trails, the prefix follows the format <code>ORG_ID/AWSLogs/ORG_ID</code>, where <code>ORG_ID</code> is the AWS organization ID. For single-account trails, use the default prefix <code>AWSLogs/</code>. Verify the prefix using the AWS CLI command: <code>aws cloudtrail describe-trails --trail-name-list TRAIL_NAME</code>. If a custom prefix is used, append it to the default prefix (e.g., <code>PREFIX/ORG_ID/AWSLogs/ORG_ID</code>).</li>
<li class=""><strong><a href="https://docs.aws.amazon.com/athena/latest/ug/query-results-specify-location.html" target="_blank" rel="noopener noreferrer" class="">Set Up Athena Query Result Location</a></strong>: Ensure an S3 bucket is configured in Athena for query results. Specify this bucket (without the <code>s3://</code> prefix) in the CloudFormation template to store query outputs.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Automate with GitHub Solution</div><div class="admonitionContent_BuS1"><p><strong>Access <a href="https://github.com/aws-samples/sample-automation-cloudtrail-athena" target="_blank" rel="noopener noreferrer" class="">CloudTrail Athena Automation Scripts</a></strong> on GitHub to deploy the CloudFormation template and streamline your CloudTrail log analysis with partitioned Athena tables.</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="use-account-specific-and-consolidated-tables-for-flexible-analysis">Use Account-Specific and Consolidated Tables for Flexible Analysis<a href="#use-account-specific-and-consolidated-tables-for-flexible-analysis" class="hash-link" aria-label="Direct link to Use Account-Specific and Consolidated Tables for Flexible Analysis" title="Direct link to Use Account-Specific and Consolidated Tables for Flexible Analysis" translate="no">​</a></h2>
<p>The solution creates two types of Athena tables to support different use cases:</p>
<ul>
<li class=""><strong>Account-Specific Tables</strong>: The <code>CloudTrailLogsPartitionedByAccount</code> Lambda function creates dedicated Athena tables (e.g., <code>trail_123456789012</code>) for each AWS account discovered in the CloudTrail S3 bucket. These tables are partitioned by region and date, enabling teams to analyze logs specific to their account without scanning irrelevant data. This is particularly useful for security teams investigating account-specific incidents or operational teams troubleshooting regional activities.</li>
<li class=""><strong>Consolidated Organization-Wide Table</strong>: The <code>CloudTrailLogsPartitionedAllAccounts</code> Lambda function maintains a unified table (e.g., <code>all_accounts_trail</code>) containing logs from all accounts in the AWS organization, partitioned by account ID, region, and date. This table supports cross-account investigations and organization-wide audits, allowing security administrators to query activity across the entire environment efficiently.</li>
</ul>
<p>Both functions use partition projection to automatically include new accounts and partitions as the organization evolves, eliminating the need for manual updates. Configure these tables to deliver logs to a centralized S3 bucket in a separate security boundary with restricted access to enforce strict security controls and segregation of duties.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="enable-daily-table-updates-for-synchronization">Enable Daily Table Updates for Synchronization<a href="#enable-daily-table-updates-for-synchronization" class="hash-link" aria-label="Direct link to Enable Daily Table Updates for Synchronization" title="Direct link to Enable Daily Table Updates for Synchronization" translate="no">​</a></h2>
<p>To ensure Athena tables remain synchronized with the AWS organization’s structure, configure the Lambda functions to execute daily updates. These updates detect new accounts and create corresponding partitions, ensuring that logs from newly added accounts or regions are included in the Athena tables. This automation reduces administrative overhead and ensures comprehensive log coverage, supporting compliance requirements such as FedRAMP or PCI-DSS that mandate continuous monitoring of account activity.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="leverage-predefined-queries-for-common-use-cases">Leverage Predefined Queries for Common Use Cases<a href="#leverage-predefined-queries-for-common-use-cases" class="hash-link" aria-label="Direct link to Leverage Predefined Queries for Common Use Cases" title="Direct link to Leverage Predefined Queries for Common Use Cases" translate="no">​</a></h2>
<p><strong><a href="https://github.com/awslabs/aws-security-analytics-bootstrap/blob/main/AWSSecurityAnalyticsBootstrap/sql/dml/analytics/cloudtrail/cloudtrail_demo_queries.sql" target="_blank" rel="noopener noreferrer" class="">Include predefined Athena queries in the solution to address common security and operational scenarios</a></strong>. For example, the “Find most frequent console users” query analyzes AWS console login frequency by user, helping identify potential unauthorized access. These queries serve as templates for custom queries, allowing teams to tailor investigations to specific needs. Store predefined queries in the Athena console’s Saved Queries section for easy access and execution.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Access Saved Security Queries</div><div class="admonitionContent_BuS1"><p><strong>Explore <a href="https://github.com/awslabs/aws-security-analytics-bootstrap/blob/main/AWSSecurityAnalyticsBootstrap/sql/dml/analytics/cloudtrail/cloudtrail_demo_queries.sql" target="_blank" rel="noopener noreferrer" class="">AWS CloudTrail Athena Demo Queries</a></strong> on GitHub to use pre-built Athena queries for common security scenarios like detecting unauthorized console access.</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="optimize-costs-with-partitioning-and-monitoring">Optimize Costs with Partitioning and Monitoring<a href="#optimize-costs-with-partitioning-and-monitoring" class="hash-link" aria-label="Direct link to Optimize Costs with Partitioning and Monitoring" title="Direct link to Optimize Costs with Partitioning and Monitoring" translate="no">​</a></h2>
<p>Partitioning CloudTrail logs reduces the amount of data scanned by Athena, directly lowering query costs. Additionally, implement the following cost management practices:</p>
<ul>
<li class=""><strong>Monitor Lambda Function Costs</strong>: The solution uses two Lambda functions, each invoked once daily. Monitor their runtime to estimate costs using the AWS Lambda pricing page. Adjust invocation frequency if needed to balance cost and update requirements.</li>
<li class=""><strong>Track Athena Query Costs</strong>: Athena charges based on the amount of data scanned per query. Partitioning minimizes scanned data, but monitor query costs using the Amazon Athena pricing page. Use AWS Budgets to set cost thresholds and alerts for CloudTrail and Athena spending.</li>
<li class=""><strong>Use AWS Cost Anomaly Detection</strong>: Configure AWS Cost Anomaly Detection to monitor CloudTrail and Athena spending. This service uses machine learning to detect unexpected cost spikes, enabling proactive cost management.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="clean-up-resources-to-avoid-unnecessary-costs">Clean Up Resources to Avoid Unnecessary Costs<a href="#clean-up-resources-to-avoid-unnecessary-costs" class="hash-link" aria-label="Direct link to Clean Up Resources to Avoid Unnecessary Costs" title="Direct link to Clean Up Resources to Avoid Unnecessary Costs" translate="no">​</a></h2>
<p>To prevent ongoing charges, delete the CloudFormation stack when the solution is no longer needed. This removes the Lambda functions, IAM roles, Glue database, and Athena tables, ensuring no residual costs are incurred. Regularly review AWS Budgets and Cost Anomaly Detection reports to identify and address any unexpected expenses related to the solution.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>Automating partitioned Athena tables for CloudTrail logs optimizes query performance, reduces costs, and enhances security and compliance investigations. By deploying account-specific and organization-wide tables, enabling daily updates, and securing the S3 bucket, this solution provides a scalable and efficient approach to CloudTrail log analysis. Integrating with CloudWatch Logs and leveraging predefined queries further streamlines investigations, while cost management practices ensure affordability. Implement this solution to achieve faster, cost-effective, and secure analysis of CloudTrail logs, supporting governance, compliance, and operational excellence in your AWS environment.</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/cloud-operations-best-practices/docs/solutions/AWS CloudTrail/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">AWS CloudTrail</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cloud-operations-best-practices/docs/solutions/application-operations/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Application Operations</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configure-partitioned-athena-tables-for-cloudtrail-logs" class="table-of-contents__link toc-highlight">Configure Partitioned Athena Tables for CloudTrail Logs</a></li><li><a href="#use-account-specific-and-consolidated-tables-for-flexible-analysis" class="table-of-contents__link toc-highlight">Use Account-Specific and Consolidated Tables for Flexible Analysis</a></li><li><a href="#enable-daily-table-updates-for-synchronization" class="table-of-contents__link toc-highlight">Enable Daily Table Updates for Synchronization</a></li><li><a href="#leverage-predefined-queries-for-common-use-cases" class="table-of-contents__link toc-highlight">Leverage Predefined Queries for Common Use Cases</a></li><li><a href="#optimize-costs-with-partitioning-and-monitoring" class="table-of-contents__link toc-highlight">Optimize Costs with Partitioning and Monitoring</a></li><li><a href="#clean-up-resources-to-avoid-unnecessary-costs" class="table-of-contents__link toc-highlight">Clean Up Resources to Avoid Unnecessary Costs</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> © 2025.  Amazon.com, Inc. or its affiliates. All Rights Reserved.</div></div></div></footer></div>
</body>
</html>