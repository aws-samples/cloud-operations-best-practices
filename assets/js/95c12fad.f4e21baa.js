"use strict";(globalThis.webpackChunkaws_cloud_operations_best_practices=globalThis.webpackChunkaws_cloud_operations_best_practices||[]).push([[5774],{1050:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"guides/AWS CloudTrail/CloudTrail Lake/CloudTrail Lake Event Enrichment/index","title":"Best Practices for CloudTrail Lake event enrichment","description":"CloudTrail event enrichment allows you to enhance management and data events by adding resource tag keys, and IAM global condition keys, including principal tag keys,  when creating or updating an event data store. This enrichment enables better categorization, searching, and analysis of CloudTrail events based on business context, such as cost allocation, financial management, operations, and data security requirements. The enriched events include an eventContext field that provides contextual information for API actions, which you can analyze by running queries in CloudTrail Lake or through federation with Amazon Athena. This feature helps organizations better understand and track their AWS resource usage and security posture by incorporating additional metadata about resources, principals, and authorization conditions into their event logs.","source":"@site/docs/guides/AWS CloudTrail/CloudTrail Lake/CloudTrail Lake Event Enrichment/index.mdx","sourceDirName":"guides/AWS CloudTrail/CloudTrail Lake/CloudTrail Lake Event Enrichment","slug":"/guides/AWS CloudTrail/CloudTrail Lake/CloudTrail Lake Event Enrichment/","permalink":"/cloud-operations-best-practices/docs/guides/AWS CloudTrail/CloudTrail Lake/CloudTrail Lake Event Enrichment/","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"CloudTrail Lake","permalink":"/cloud-operations-best-practices/docs/guides/AWS CloudTrail/CloudTrail Lake/"},"next":{"title":"CloudTrail Data Events","permalink":"/cloud-operations-best-practices/docs/guides/AWS CloudTrail/CloudTrail-DataEvents/"}}');var i=t(4848),r=t(8453);const s={sidebar_position:3},o="Best Practices for CloudTrail Lake event enrichment",l={},c=[{value:"Resource Tag Enrichment",id:"resource-tag-enrichment",level:3},{value:"IAM Global Condition Keys Enrichment",id:"iam-global-condition-keys-enrichment",level:3},{value:"Service Considerations",id:"service-considerations",level:3},{value:"Event Context Management",id:"event-context-management",level:3},{value:"Operational Considerations",id:"operational-considerations",level:3},{value:"Sample SQL Queries for CloudTrail Lake",id:"sample-sql-queries-for-cloudtrail-lake",level:3},{value:"<strong>Resource Tags for Event Enrichment</strong>",id:"resource-tags-for-event-enrichment",level:4},{value:"<strong>Resource Tags for Event Enrichment on Data Classification Tag</strong>",id:"resource-tags-for-event-enrichment-on-data-classification-tag",level:4},{value:"<strong>Sample Query to create a Visualization Chart for Event Enrichment</strong>",id:"sample-query-to-create-a-visualization-chart-for-event-enrichment",level:4},{value:"Cloud Operation Show: Tag It &amp; Track It: AWS CloudTrail Event Enrichment and Expansions Explained",id:"cloud-operation-show-tag-it--track-it-aws-cloudtrail-event-enrichment-and-expansions-explained",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"best-practices-for-cloudtrail-lake-event-enrichment",children:"Best Practices for CloudTrail Lake event enrichment"})}),"\n",(0,i.jsx)(n.p,{children:"CloudTrail event enrichment allows you to enhance management and data events by adding resource tag keys, and IAM global condition keys, including principal tag keys,  when creating or updating an event data store. This enrichment enables better categorization, searching, and analysis of CloudTrail events based on business context, such as cost allocation, financial management, operations, and data security requirements. The enriched events include an eventContext field that provides contextual information for API actions, which you can analyze by running queries in CloudTrail Lake or through federation with Amazon Athena. This feature helps organizations better understand and track their AWS resource usage and security posture by incorporating additional metadata about resources~~, principals~~, and authorization conditions into their event logs."}),"\n",(0,i.jsx)(n.h3,{id:"resource-tag-enrichment",children:"Resource Tag Enrichment"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Configure resource tag keys during event data store creation or updates to categorize and analyze events based on business context"}),"\n",(0,i.jsx)(n.li,{children:"Consider that resource tags added after resource creation may experience delays before appearing in CloudTrail events"}),"\n",(0,i.jsx)(n.li,{children:"Be aware that resource tags for deleted resources might not include tag information"}),"\n",(0,i.jsx)(n.li,{children:"Understand that tags applied at resource creation time experience minimal or no delays"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"iam-global-condition-keys-enrichment",children:"IAM Global Condition Keys Enrichment"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Select relevant IAM global condition keys to include additional context about authorization processes"}),"\n",(0,i.jsx)(n.li,{children:"Remember that configured condition keys may not appear in every event if they weren't relevant to the IAM policy evaluation"}),"\n",(0,i.jsxs)(n.li,{children:["Consider using ",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-context-events.html#condition-keys-supported-services",children:"supported condition keys"})," like:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["aws",":FederatedProvider"]}),"\n",(0,i.jsxs)(n.li,{children:["aws",":MultiFactorAuthPresent"]}),"\n",(0,i.jsxs)(n.li,{children:["aws",":PrincipalAccount"]}),"\n",(0,i.jsxs)(n.li,{children:["aws",":PrincipalType"]}),"\n",(0,i.jsxs)(n.li,{children:["aws",":ViaAWSService"]}),"\n",(0,i.jsxs)(n.li,{children:["aws",":SecureTransport"]}),"\n",(0,i.jsxs)(n.li,{children:["And many others (",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-context-events.html#condition-keys-supported-services",children:"Supported IAM global condition keys for enriched events"}),")"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"service-considerations",children:"Service Considerations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Be aware of ",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-context-events.html#resource-tags-supported-services",children:"services"})," that may experience delays in resource tag updates, including:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Amazon S3"}),"\n",(0,i.jsx)(n.li,{children:"AWS CloudTrail"}),"\n",(0,i.jsx)(n.li,{children:"AWS Lambda"}),"\n",(0,i.jsx)(n.li,{children:"Amazon DynamoDB"}),"\n",(0,i.jsx)(n.li,{children:"AWS Organizations"}),"\n",(0,i.jsx)(n.li,{children:"AWS KMS"}),"\n",(0,i.jsx)(n.li,{children:"Amazon SQS"}),"\n",(0,i.jsxs)(n.li,{children:["And many others (the ",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-context-events.html#resource-tags-supported-services",children:"AWS documentation"})," lists additional services)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"event-context-management",children:"Event Context Management"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Monitor the eventContext field in CloudTrail events for enriched information"}),"\n",(0,i.jsx)(n.li,{children:"Note that the eventContext field will only be present in events for event data stores configured with enrichment"}),"\n",(0,i.jsxs)(n.li,{children:["Be aware that delayed events will not include eventContext data. Events that have delayed delivery contains an \u201caddendum\u201c field that shows information about why the event was delayed. Read more about ",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-record-contents.html",children:"CloudTrail events records"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Maintain the AWSServiceRoleForCloudTrailEventContext service-linked role to ensure proper tag population"}),"\n",(0,i.jsx)(n.li,{children:"Adding event context can increase the overall size of the event which can lead to additional ingestion cost for CloudTrail Lake"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"operational-considerations",children:"Operational Considerations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Plan for potential service outages that may cause delays in resource tag updates"}),"\n",(0,i.jsx)(n.li,{children:"Monitor addendum fields in CloudTrail events that include information about resource tag changes after service outages"}),"\n",(0,i.jsx)(n.li,{children:"Understand that events in Event history, EventBridge, and trails will not include the eventContext field"}),"\n",(0,i.jsx)(n.li,{children:"Consider the business requirements for cost allocation, operations, and security when selecting tag keys and condition keys for enrichment"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"sample-sql-queries-for-cloudtrail-lake",children:"Sample SQL Queries for CloudTrail Lake"}),"\n",(0,i.jsx)(n.h4,{id:"resource-tags-for-event-enrichment",children:(0,i.jsx)(n.strong,{children:"Resource Tags for Event Enrichment"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"SELECT eventtime, eventName, substr(userIdentity.arn, strpos(userIdentity.arn, '/') +1) as IAM,\neventContext.tagContext.resourceTags[1].tags as tags,\neventContext.tagContext.resourceTags[1].arn as resourceArn, \nelement_at(requestParameters, 'key') as S3Object\nFROM $EDS_ID\nWHERE eventContext IS NOT NULL \nand eventSource = 's3.amazonaws.com'\nand eventname in ('DeleteObject', 'PutObject')\nAND eventtime >= '2025-06-05 00:00:00'\nAND eventtime <= '2025-06-05 23:59:59'\n"})}),"\n",(0,i.jsx)(n.h4,{id:"resource-tags-for-event-enrichment-on-data-classification-tag",children:(0,i.jsx)(n.strong,{children:"Resource Tags for Event Enrichment on Data Classification Tag"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"SELECT eventtime, eventName, substr(userIdentity.arn, strpos(userIdentity.arn, '/') +1) as IAM,\nelement_at(eventContext.tagContext.resourceTags[1].tags, 'DataClassification') as DataClassification,\neventContext.tagContext.resourceTags[1].arn as resourceArn, \nelement_at(requestParameters, 'key') as S3Object\nFROM $EDS_ID\nWHERE eventContext IS NOT NULL\nand element_at(eventContext.tagContext.resourceTags[1].tags, 'DataClassification') = 'sensitive'\nand eventSource = 's3.amazonaws.com'\nand eventname in ('DeleteObject', 'PutObject')\nAND eventtime >= '2025-06-05 00:00:00'\nAND eventtime <= '2025-06-05 23:59:59'\n"})}),"\n",(0,i.jsx)(n.h4,{id:"sample-query-to-create-a-visualization-chart-for-event-enrichment",children:(0,i.jsx)(n.strong,{children:"Sample Query to create a Visualization Chart for Event Enrichment"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"SELECT count(*) as count, eventName, substr(userIdentity.arn, \nstrpos(userIdentity.arn, '/') +1) as IAM,\nelement_at(eventContext.tagContext.resourceTags[1].tags, 'DataClassification') as DataClassification,\neventContext.tagContext.resourceTags[1].arn as resourceArn, \nelement_at(requestParameters, 'key') as S3Object\nFROM $EDS_ID\nWHERE eventContext IS NOT NULL\nand element_at(eventContext.tagContext.resourceTags[1].tags, 'DataClassification') = 'sensitive'\nand eventSource = 's3.amazonaws.com'\nand eventname in ('DeleteObject', 'PutObject')\nAND eventtime >= '2025-06-05 00:00:00'\nAND eventtime <= '2025-06-05 23:59:59'\nGroup BY eventName,\nsubstr(userIdentity.arn, strpos(userIdentity.arn, '/') +1),\nelement_at(eventContext.tagContext.resourceTags[1].tags, 'DataClassification'),\neventContext.tagContext.resourceTags[1].arn,\nelement_at(requestParameters, 'key')\n"})}),"\n",(0,i.jsx)(n.h3,{id:"cloud-operation-show-tag-it--track-it-aws-cloudtrail-event-enrichment-and-expansions-explained",children:"Cloud Operation Show: Tag It & Track It: AWS CloudTrail Event Enrichment and Expansions Explained"}),"\n",(0,i.jsx)("div",{align:"center",children:(0,i.jsx)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/IELtInifymY?si=uupyo9_wx0Kcx1Vw",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",referrerpolicy:"strict-origin-when-cross-origin",allowfullscreen:!0})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var a=t(6540);const i={},r=a.createContext(i);function s(e){const n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);